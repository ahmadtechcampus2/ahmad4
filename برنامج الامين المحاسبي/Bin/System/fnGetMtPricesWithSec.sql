###########################################################################
CREATE FUNCTION fnGetMtPricesWithSec (@PriceType INT, @PricePolicy INT, @UseUnit AS INT, @curGUID [UNIQUEIDENTIFIER], @curDate DATETIME)
RETURNS 
	@Result TABLE(
		[mtGUID]			[UNIQUEIDENTIFIER],
		[mtNumber]	 		[INT],
		[mtName] 			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtCode] 			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtLatinName]	 	[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtBarCode]  		[NVARCHAR](500) COLLATE ARABIC_CI_AI,
		[mtBarCode2]		[NVARCHAR](500) COLLATE ARABIC_CI_AI,
		[mtBarCode3]		[NVARCHAR](500) COLLATE ARABIC_CI_AI,
		[mtCodedCode] 		[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtGroup]			[UNIQUEIDENTIFIER],
		[mtUnity]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtSpec]			[NVARCHAR](1000) COLLATE ARABIC_CI_AI,
		[mtQty]				[FLOAT],
		[mtHigh]			[FLOAT],
		[mtLow]				[FLOAT],
		[mtPrice]			[FLOAT],
		[mtPriceType]		[INT],
		[mtSellType]		[INT],
		[mtBonusOne]		[FLOAT],
		[mtPicture]			[UNIQUEIDENTIFIER],
		[mtCurrencyVal]		[FLOAT],
		[mtCurrencyPtr]		[UNIQUEIDENTIFIER],
		[mtUseFlag]			[FLOAT],
		[mtOrigin]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtCompany]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtColor]			[NVARCHAR](255) COLLATE ARABIC_CI_AI,
		[mtProvenance]		[NVARCHAR](255) COLLATE ARABIC_CI_AI,
		[mtQuality]			[NVARCHAR](255) COLLATE ARABIC_CI_AI,
		[mtModel]			[NVARCHAR](255) COLLATE ARABIC_CI_AI,
		[mtType]			[INT], 
		[mtSecurity]		[INT],
		[mtLastPriceDate]	[DATETIME],
		[mtBonus]			[FLOAT],
		[mtUnit2]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtUnit2Fact]		[FLOAT],
		[mtUnit3]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtUnit3Fact]		[FLOAT], 
		[mtFlag]			[FLOAT],
		[mtPos]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtDim]			[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtDefUnitFact]	[FLOAT],
		[mtDefUnitName]	[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[mtDefUnit]		[NVARCHAR](256) COLLATE ARABIC_CI_AI,
		[grName]			[NVARCHAR](256) COLLATE ARABIC_CI_AI
	)
AS BEGIN
	IF (@UseUnit = 0 ) OR (@PriceType = 2 AND (@PricePolicy = 121/*Avg*/))-- OR @PricePolicy = 120/*Max*/ ))
	INSERT INTO @Result
		SELECT
			[mtGUID],
			[mtNumber],
			[mtName],
			[mtCode],
			[mtLatinName],
			[mtBarCode],
			[mtBarCode2],
			[mtBarCode3],
			[mtCodedCode],
			[mtGroup],
			[mtUnity],
			[mtSpec],
			[mtQty],
			[mtHigh],
			[mtLow],
			[mt].[fixedPrice],
			[mtPriceType],
			[mtSellType],
			[mtBonusOne],
			[mtPicture],
			[mtCurrencyVal],
			[mtCurrencyPtr],
			[mtUseFlag],
			[mtOrigin],
			[mtCompany],
			[mtColor],
			[mtProvenance],
			[mtQuality],
			[mtModel],
			[mtType],
			[mtSecurity],
			[mtLastPriceDate],
			[mtBonus],
			[mtUnit2],
			[mtUnit2Fact],
			[mtUnit3],
			[mtUnit3Fact],
			[mtFlag],
			[mtPos],
			[mtDim],
			[mtDefUnitFact],
			[mtDefUnitName],
			[mtDefUnit],
			[gr].[grName]
		FROM 
			[dbo].[fnExtended_mt_fixed]( @priceType, @pricePolicy, @useUnit, @curGUID, @curDate) AS [mt]
			INNER JOIN [vwgr] As [gr] 
			ON [gr].[grGUID] = [mt].[mtGroup]

	ELSE IF @UseUnit = 1
		INSERT INTO @Result
			SELECT
				[mtGUID],
				[mtNumber],
				[mtName],
				[mtCode],
				[mtLatinName],
				[mtBarCode],
				[mtBarCode2],
				[mtBarCode3],
				[mtCodedCode],
				[mtGroup],
				[mtUnity],
				[mtSpec],
				[mtQty],
				[mtHigh],
				[mtLow],
				[mt].[fixedPrice] / (CASE [mtUnit2Fact] WHEN 0 THEN 1 ELSE [mtUnit2Fact] END) AS [mtPrice],
				[mtPriceType],
				[mtSellType],
				[mtBonusOne],
				[mtPicture],
				[mtCurrencyVal],
				[mtCurrencyPtr],
				[mtUseFlag],
				[mtOrigin],
				[mtCompany],
				[mtColor],
				[mtProvenance],
				[mtQuality],
				[mtModel],
				[mtType],
				[mtSecurity],
				[mtLastPriceDate],
				[mtBonus],
				[mtUnit2],
				[mtUnit2Fact],
				[mtUnit3],
				[mtUnit3Fact],
				[mtFlag],
				[mtPos],
				[mtDim],
				[mtDefUnitFact],
				[mtDefUnitName],
				[mtDefUnit],
				[gr].[grName]
			FROM
				[dbo].[fnExtended_mt_fixed]( @priceType, @pricePolicy, @useUnit, @curGUID, @curDate) AS [mt]
				INNER JOIN [vwgr] As [gr]
				ON [gr].[grGUID] = [mt].[mtGroup]

	ELSE IF @UseUnit = 2
		INSERT INTO @Result
			SELECT
				[mtGUID],
				[mtNumber],
				[mtName],
				[mtCode],
				[mtLatinName],
				[mtBarCode],
				[mtBarCode2],
				[mtBarCode3],
				[mtCodedCode],
				[mtGroup],
				[mtUnity],
				[mtSpec],
				[mtQty],
				[mtHigh],
				[mtLow],
				[mt].[fixedPrice] / (CASE [mtUnit3Fact] WHEN 0 THEN 1 ELSE [mtUnit3Fact] END) AS mtPrice,
				[mtPriceType],
				[mtSellType],
				[mtBonusOne],
				[mtPicture],
				[mtCurrencyVal],
				[mtCurrencyPtr],
				[mtUseFlag],
				[mtOrigin],
				[mtCompany],
				[mtColor],
				[mtProvenance],
				[mtQuality],
				[mtModel],
				[mtType],
				[mtSecurity],
				[mtLastPriceDate],
				[mtBonus],
				[mtUnit2],
				[mtUnit2Fact],
				[mtUnit3],
				[mtUnit3Fact],
				[mtFlag],
				[mtPos],
				[mtDim],
				[mtDefUnitFact],
				[mtDefUnitName],
				[mtDefUnit],
				[gr].[grName]
			FROM
				[dbo].[fnExtended_mt_fixed]( @priceType, @pricePolicy, @useUnit, @curGUID, @curDate) AS [mt]
				INNER JOIN [vwgr] As [gr]
				ON [gr].[grGUID] = [mt].[mtGroup]

	ELSE IF @UseUnit = 3 ---defunit
		INSERT INTO @Result 
			SELECT
				[mtGUID],
				[mtNumber],
				[mtName],
				[mtCode],
				[mtLatinName],
				[mtBarCode],
				[mtBarCode2],
				[mtBarCode3],
				[mtCodedCode], 
				[mtGroup],
				[mtUnity],
				[mtSpec],
				[mtQty],
				[mtHigh],
				[mtLow],
				[mt].[fixedPrice] / (CASE [mtDefUnitFact] WHEN 0 THEN 1 ELSE [mtDefUnitFact] END) AS [mtPrice],
				[mtPriceType],
				[mtSellType],
				[mtBonusOne],
				[mtPicture],
				[mtCurrencyVal],
				[mtCurrencyPtr],
				[mtUseFlag],
				[mtOrigin], 
				[mtCompany],
				[mtColor],
				[mtProvenance],
				[mtQuality],
				[mtModel],
				[mtType],
				[mtSecurity],
				[mtLastPriceDate],
				[mtBonus],
				[mtUnit2],
				[mtUnit2Fact],
				[mtUnit3],
				[mtUnit3Fact],
				[mtFlag],
				[mtPos],
				[mtDim],
				[mtDefUnitFact],
				[mtDefUnitName],
				[mtDefUnit],
				[gr].[grName]
			FROM
				[dbo].[fnExtended_mt_fixed]( @priceType, @pricePolicy, @useUnit, @curGUID, @curDate) AS [mt]
				INNER JOIN [vwgr] As [gr] ON [gr].[grGUID] = [mt].[mtGroup]
	RETURN
END
###########################################################################
#END