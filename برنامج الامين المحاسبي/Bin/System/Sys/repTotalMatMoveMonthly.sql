############################################################## 
CREATE PROCEDURE repTotalMatMoveMonthly
@FROMDATE DATETIME, 
		@TODATE DATETIME, 
		@STR   NVARCHAR(max) = '', 
		@STORE UNIQUEIDENTIFIER, 
		@MAT UNIQUEIDENTIFIER, 
		@COST UNIQUEIDENTIFIER, 
		@GRP UNIQUEIDENTIFIER, 
		@SRCTYPES UNIQUEIDENTIFIER,
		@VeiwCFlds 			NVARCHAR (max) = '', 	-- New Parameter to check veiwing of Custom Fields 
		@USEUNIT INT = 0, 
		@MATCOND UNIQUEIDENTIFIER, 
		@SHWGRP	BIT = 0, 
		@GRPLEVEL INT = 0, 
		@SORTBY INT = 0, 
		@COLLECT1 INT = 0, 
		@COLLECT2 INT = 0, 
		@COLLECT3 INT = 0 
		
AS 
	SET NOCOUNT ON 
	DECLARE @LEVEL INT , @CNT INT, @MAXLEVEL int 
	Declare @CF_Table NVARCHAR(255) --Mapped Table for Custom Fields
	
	CREATE TABLE [#SECVIOL]([TYPE] [INT],[CNT] [INTEGER]); 
	CREATE TABLE [#BILLSTYPESTBL] ([TYPEGUID] [UNIQUEIDENTIFIER] ,[USERSECURITY] [INTEGER],[USERREADPTRICESECURITY] [INT],[UNPOSTEDSECURITY] [INTEGER])  ; 
	CREATE TABLE [#STORETBL] ([STOREGUID] [UNIQUEIDENTIFIER] ,[SECURITY] [INT]); 
	CREATE TABLE [#MATTBL]( [MATGUID] [UNIQUEIDENTIFIER], [MTSECURITY] [INT]); 
	CREATE TABLE [#COSTTBL]( [COSTGUID] [UNIQUEIDENTIFIER], [SECURITY] [INT]); 
	CREATE TABLE #MATTBL2(
	[MatGUID] [UNIQUEIDENTIFIER], [MTSECURITY] INT, CODE NVARCHAR(256), [NAME] NVARCHAR(256), Color NVARCHAR(256), 
		Provenance NVARCHAR(256), Quality NVARCHAR(256), SPEC NVARCHAR(1000), Model NVARCHAR(256), 
		BarCode2 NVARCHAR(256), 
		BarCode3 NVARCHAR(256), 
		Pos NVARCHAR(256), 
		Dim NVARCHAR(256), 
		Origin NVARCHAR(256),
		VAT FLOAT,   
		Company NVARCHAR(256), 
		Type INT, 
		LatinName NVARCHAR(256), 
		BarCode NVARCHAR(256), 
		UNITFACT FLOAT, 
		UNIT NVARCHAR(256), 
		GrpName NVARCHAR(256), 
		MTGROUPGUID [UNIQUEIDENTIFIER])
	CREATE TABLE #RES(
		CODE NVARCHAR(256),
		[NAME] NVARCHAR(256),
		MATGUID [UNIQUEIDENTIFIER], 
		GROUPGUID [UNIQUEIDENTIFIER], 
		STARTDATE DATETIME, 
		ENDDATE DATETIME, 
		ISGRP BIT, 
		[PATH] VARCHAR(8000), 
		INQTY FLOAT, 
		OUTQTY FLOAT)
	 
	INSERT INTO [#BILLSTYPESTBL] EXEC  [PRCGETBILLSTYPESLIST2] 	@SRCTYPES; 
	INSERT INTO [#STORETBL] EXEC [PRCGETSTORESLIST] @STORE; 
	INSERT INTO [#MATTBL]	EXEC [PRCGETMATSLIST] 	@MAT, @GRP, -1, @MATCOND; 
	INSERT INTO [#COSTTBL]	EXEC [PRCGETCOSTSLIST] 	@COST; 
	 
	IF (@COST = 0X00)  
		INSERT INTO [#COSTTBL] VALUES(0X00,0); 
	INSERT INTO #MATTBL2
	SELECT 	[MatGUID], [MTSECURITY], MT.CODE, MT.[NAME], MT.Color, 
		MT.Provenance, 
		MT.Quality, 
		MT.SPEC, 
		MT.Model, 
		MT.BarCode2, 
		MT.BarCode3, 
		MT.Pos, 
		MT.Dim, 
		MT.Origin,
		MT.VAT,   
		MT.Company, 
		MT.Type, 
		MT.LatinName, 
		MT.BarCode, 
		CASE @USEUNIT WHEN 0 THEN 1  
			WHEN 1 THEN CASE UNIT2FACT WHEN 0 THEN 1 ELSE  UNIT2FACT END 
			WHEN 2 THEN CASE UNIT3FACT WHEN 0 THEN 1 ELSE  UNIT3FACT END 
		ELSE 
			CASE DEFUNIT WHEN 1 THEN 1  
				WHEN 2 THEN CASE UNIT2FACT WHEN 0 THEN 1 ELSE  UNIT2FACT END 
				WHEN 3 THEN CASE UNIT3FACT WHEN 0 THEN 1 ELSE  UNIT3FACT END 
			END 
		END UNITFACT, 
		CASE @USEUNIT WHEN 0 THEN Unity  
			WHEN 1 THEN CASE UNIT2FACT WHEN 0 THEN Unity ELSE  Unit2 END 
			WHEN 2 THEN CASE UNIT3FACT WHEN 0 THEN Unity ELSE  Unit3 END 
		ELSE 
			CASE DEFUNIT WHEN 1 THEN Unity  
				WHEN 2 THEN CASE UNIT2FACT WHEN 0 THEN Unity ELSE  Unit2 END 
				WHEN 3 THEN CASE UNIT3FACT WHEN 0 THEN Unity ELSE  Unit3 END 
			END 
		END UNIT,
		Gr.Name GrpName,
		MT.GROUPGUID MTGROUPGUID 
	FROM #MATTBL M INNER JOIN MT000 MT ON MT.GUID =  MATGUID
		INNER JOIN gr000 Gr ON MT.GroupGUID =  Gr.GUID; 
	 
	CREATE TABLE #RESULT 
	( 
		[NAME] 		NVARCHAR(256) COLLATE ARABIC_CI_AI, 
		CODE		NVARCHAR(256) COLLATE ARABIC_CI_AI, 
		MTSECURITY 	INT, 
		SECURITY 	INT, 
		USERSECURITY  	INT, 
		QTY 		FLOAT, 
		BTDIRECTION 	SMALLINT, 
		STARTDATE 	SMALLDATETIME, 
		ENDDATE 	SMALLDATETIME, 
		MATGUID 	UNIQUEIDENTIFIER, 
		GROUPGUID	UNIQUEIDENTIFIER, 
		ISGRP		BIT, 
		PATH		NVARCHAR(4000), 
		[LEVEL] 	INT, 
		GRPLEVEL	INT 
	); 
	 
	INSERT INTO #RESULT 
		SELECT  [NAME], 
			[CODE], 
			MTSECURITY, 
			BUSECURITY, 
			BT.[USERSECURITY], 
			SUM((VW.BIQTY  + VW.BIBONUSQNT)/UNITFACT), 
			VW.BTDIRECTION DIR, 
			P.STARTDATE , 
			P.ENDDATE , 
			VW.BIMATPTR , 
			MTGROUPGUID, 
			0, 
			'', 
			0, 
			0 
		FROM VWBUBI VW 
		  INNER JOIN #MATTBL2  			MT ON MT.MATGUID   = VW.BIMATPTR 
	 	  INNER JOIN #STORETBL 			ST ON ST.STOREGUID = VW.BISTOREPTR 
		  INNER JOIN #COSTTBL  			CO ON CO.COSTGUID  = VW.BICOSTGUID 
		  INNER JOIN #BILLSTYPESTBL		BT ON BT.TYPEGUID  = VW.BUTYPE 
		  INNER JOIN [FNGETSTRTOPERIOD](@STR)	P  ON VW.BUDATE BETWEEN P.STARTDATE AND P.ENDDATE 
		WHERE VW.BUDATE BETWEEN @FROMDATE AND @TODATE 
		    AND BUISPOSTED > 0 
		GROUP BY P.STARTDATE, 
			 P.ENDDATE, 
			 VW.BIMATPTR, 
			 VW.BTDIRECTION, 
			 [NAME], 
			 [CODE], 
			 MTSECURITY, 
			 BUSECURITY, 
			 BT.[USERSECURITY], 
			 MTGROUPGUID; 

	IF (@SHWGRP > 0) 
	BEGIN 
		CREATE TABLE #GR([GUID] UNIQUEIDENTIFIER, [PATH] VARCHAR(8000), CODE NVARCHAR(256),
						 [NAME] NVARCHAR(256), PARENTGUID UNIQUEIDENTIFIER, lEVEL INT)
		 
		INSERT INTO #GR
		SELECT A.GUID,A.PATH,GR.CODE,GR.[NAME],GR.PARENTGUID,lEVEL 
		FROM  [DBO].[FNGETGROUPSOFGROUPSORTED](@GRP,@SORTBY) A INNER JOIN GR000 GR ON GR.GUID = A.GUID 
		 
		UPDATE R SET PATH = GR.PATH,GRPLEVEL = GR.LEVEL FROM #RESULT R INNER JOIN #GR GR ON GR.GUID = R.GROUPGUID 
		INSERT INTO #RESULT ( 
			[NAME],CODE,QTY ,BTDIRECTION, 
			STARTDATE,ENDDATE, 
			MATGUID,GROUPGUID, 
			ISGRP,PATH,[LEVEL],GRPLEVEL ) 
		SELECT  
			GR.[NAME],GR.CODE,SUM(QTY) ,BTDIRECTION, 
			STARTDATE,ENDDATE, 
			R.GROUPGUID,PARENTGUID, 
			1,GR.PATH,	1,GR.LEVEL 
		FROM #RESULT R INNER JOIN #GR GR ON GR.GUID = R.GROUPGUID 
		GROUP BY  
		GR.[NAME],GR.CODE ,BTDIRECTION, 
			STARTDATE,ENDDATE, 
			R.GROUPGUID,PARENTGUID, 
			GR.PATH,GR.LEVEL 
		SET @CNT = 1 
		SET @LEVEL = 1 
		WHILE (@CNT > 0) 
		BEGIN 
			INSERT INTO #RESULT ( 
				[NAME],CODE,QTY ,BTDIRECTION, 
				STARTDATE,ENDDATE, 
				MATGUID,GROUPGUID, 
				ISGRP,PATH,[LEVEL],GRPlEVEL) 
			SELECT  
				GR.[NAME],GR.CODE,SUM(QTY) ,BTDIRECTION, 
				STARTDATE,ENDDATE, 
				R.GROUPGUID,PARENTGUID, 
				1,GR.PATH, @LEVEL + 1,GR.LEVEL   
			FROM #RESULT R INNER JOIN #GR GR ON GR.GUID = R.GROUPGUID 
			WHERE R.LEVEL = @LEVEL 
			GROUP BY  
			GR.[NAME],GR.CODE ,BTDIRECTION, 
				STARTDATE,ENDDATE, 
				R.GROUPGUID,PARENTGUID, 
				GR.PATH,GR.LEVEL 
			SET @CNT = @@ROWCOUNT 
			SET @LEVEL = @LEVEL + 1 
		END 
		IF (@GRPLEVEL > 0) 
		BEGIN 
			SELECT @MAXLEVEL = MAX(GRPLEVEL) FROM #RESULT 
			WHILE (@MAXLEVEL > @GRPLEVEL - 1 ) 
			BEGIN 
				UPDATE R SET GRPLEVEL = GRPLEVEL - 1, R.GROUPGUID = GR.GUID, R.PATH = GR.PATH 
				FROM #RESULT R 
				INNER JOIN #GR G ON G.GUID =  R.GROUPGUID 
				INNER JOIN #GR GR ON G.GUID = GR.GUID  
				WHERE ISGRP = 0 AND GRPLEVEL = @MAXLEVEL 
				 
				DELETE R FROM #RESULT R 
				INNER JOIN #GR G ON G.GUID =  R.GROUPGUID 
				 WHERE R.ISGRP = 1 AND R.GRPLEVEL = @MAXLEVEL 
				 
				 SET @MAXLEVEL = @MAXLEVEL -1 
			END 
		END 
	END 
	 
	EXEC PRCCHECKSECURITY 
	 
	--SELECT  [STARTDATE], 
	--	[ENDDATE] 
	-- FROM #RESULT 
	--GROUP BY [STARTDATE],[ENDDATE] ORDER BY [STARTDATE]; 
	 
	INSERT INTO #RES
	SELECT  CODE, 
		[NAME], 
		MATGUID, 
		GROUPGUID, 
		STARTDATE,
		ENDDATE,
		ISGRP, 
		PATH, 
		SUM( CASE BTDIRECTION WHEN 1 THEN 1 ELSE 0 END * QTY ) INQTY, 
		SUM( CASE BTDIRECTION WHEN -1 THEN 1 ELSE 0 END * QTY ) OUTQTY  
	FROM #RESULT 
	GROUP BY CODE, [NAME],MATGUID, GROUPGUID, STARTDATE, ENDDATE, ISGRP, PATH 

-------------------------------------------------------------------------------------------------	 
	DECLARE @COL1 NVARCHAR(100), @COL2 NVARCHAR(100), @COL3 NVARCHAR(100), @SQL NVARCHAR(1000); 
	IF (@COLLECT1 > 0)  
	BEGIN  
		SET @COL1 = CASE @Collect1 WHEN 11 THEN 'GR.' ELSE 'MT.' END + dbo.fnGetMatCollectedFieldName(@Collect1, DEFAULT)  
		SET @COL2 = CASE @Collect2 WHEN 11 THEN 'GR.' ELSE 'MT.' END + dbo.fnGetMatCollectedFieldName(@Collect2, DEFAULT)  
		SET @COL3 = CASE @Collect3 WHEN 11 THEN 'GR.' ELSE 'MT.' END + dbo.fnGetMatCollectedFieldName(@Collect3, DEFAULT)  
		  
		SET @Sql = 'SELECT R.MATGUID MGUID, ' +  @col1 + ' AS [Col1]' --CASE WHEN @Collect1 = 11 THEN '' ELSE  '[mt].' END +  
		IF @Collect2 > 0  
			SET @Sql = @Sql + ', ' + @col2 + ' AS [Col2]'  
		IF @Collect3 > 0  
			SET @Sql = @Sql + ', ' + @col3 + ' AS [Col3]'  
		SET @Sql = 	@Sql + ',   
				R.STARTDATE,
				R.ENDDATE,
				R.ISGRP,  
				R.PATH,  
				SUM(INQTY)  INQTY,  
				SUM(OUTQTY) OUTQTY' 
		IF @VeiwCFlds <> ''	   
			SET @Sql = @Sql + @VeiwCFlds   
		SET @Sql = @Sql +  ' FROM #RES R  
			INNER JOIN #MATTBL2 [mt] ON [mt].[MatGUID] = R.MATGUID   '  
		 
		 +  dbo.fnGetInnerJoinGroup(CASE WHEN @Collect1 = 11 OR @Collect2 = 11 OR @Collect3 = 11 THEN 1 ELSE 0 END ,'MTGROUPGUID') 
		   
		IF @VeiwCFlds <> ''  
		BEGIN  
			SET @CF_Table = (SELECT CFGroup_Table FROM CFMapping000 WHERE Orginal_Table = 'mt000')  -- Mapping Table	  
			SET @Sql = @Sql + ' LEFT JOIN ' + @CF_Table + ' ON R.MATGUID = ' + @CF_Table + '.Orginal_Guid ' 	  
		END  
		  
		SET @Sql = @Sql + '  
			GROUP BY R.MATGUID, ' + @col1    
		IF @Collect2 > 0  
			SET @Sql = @Sql + ', ' +  @col2  
		IF @Collect3 > 0  
			 SET @Sql = @Sql +', ' +  @col3   
		
		SET @Sql = @Sql  + ' , R.STARTDATE, R.ENDDATE, R.ISGRP, R.PATH'
		+
			CASE @SORTBY  
					WHEN 3  THEN ',MT.LATINNAME'  
					WHEN 4  THEN ',CAST(MT.TYPE AS NVARCHAR)'  
					WHEN 5  THEN ',MT.SPEC'  
					WHEN 6  THEN ',MT.COLOR'  
					WHEN 7  THEN ',MT.PROVENANCE'  
					WHEN 8  THEN ',MT.DIM'  
					WHEN 9  THEN ',MT.COMPANY'  
					WHEN 10 THEN ',MT.BARCODE'  
					ELSE ' '  
				END    		  
		 
		IF @VeiwCFlds <> ''	 
			SET @Sql = @Sql + @VeiwCFlds   
		SET @SQL = @SQL + '  
			ORDER BY ' + 
			 
		CASE @SHWGRP WHEN 1 THEN 'R.PATH,  ' ELSE '' END + 
	    CASE @SHWGRP WHEN 1 THEN ' R.ISGRP  DESC,'	ELSE '' END + 
		CASE @SORTBY 
					WHEN 1  THEN 'R.CODE,' 
					WHEN 2  THEN 'R.NAME,' 
					WHEN 3  THEN 'MT.LATINNAME,' 
					WHEN 4  THEN 'CAST(MT.TYPE AS NVARCHAR),' 
					WHEN 5  THEN 'MT.SPEC,' 
					WHEN 6  THEN 'MT.COLOR,' 
					WHEN 7  THEN 'MT.PROVENANCE,' 
					WHEN 8  THEN 'MT.DIM,' 
					WHEN 9  THEN 'MT.COMPANY,' 
					WHEN 10 THEN 'MT.BARCODE,' 
					ELSE ' ' 
				END 
				 + ' 
				R.STARTDATE '
		
		EXEC (@SQL) 
		 
	END 
	ELSE 
	BEGIN 
		SET @Sql ='	SELECT  R.MATGUID MGUID, R.CODE MATCODE, R.NAME MATNAME, R.ISGRP, R.PATH, R.STARTDATE, R.ENDDATE, R.INQTY, R.OUTQTY, ISNULL(R.GROUPGUID, 0x0) MTGROUPGUID'
			
		IF @VeiwCFlds <> ''	  
			SET @Sql = @Sql + @VeiwCFlds 
			
		SET @Sql = @Sql+	' FROM #RES R LEFT OUTER JOIN #MATTBL2 MT ON MT.MATGUID = R.MATGUID' 
		IF @VeiwCFlds <> '' 
		BEGIN 
			SET @CF_Table = (SELECT CFGroup_Table FROM CFMapping000 WHERE Orginal_Table = 'mt000')  -- Mapping Table	 
			SET @Sql = @Sql + ' LEFT JOIN ' + @CF_Table + ' ON R.MATGUID = ' + @CF_Table + '.Orginal_Guid ' 	 
		END  
		
		SET @Sql = @Sql+ ' ORDER BY '
		
		IF (@SHWGRP = 1)
			SET @Sql = @Sql + ' R.PATH , R.ISGRP DESC, '
		
		
		IF (@SORTBY = 1) SET  @Sql = @Sql+ ' R.CODE, ' 
		IF (@SORTBY = 2) SET  @Sql = @Sql+ ' R.NAME, ' 
		IF (@SORTBY = 3)  SET  @Sql = @Sql+ ' MT.LATINNAME, ' 
		IF (@SORTBY = 4) SET  @Sql = @Sql+ ' CAST(MT.TYPE AS NVARCHAR) , ' 
		IF (@SORTBY = 5)SET  @Sql = @Sql+ ' MT.SPEC , '
		IF (@SORTBY = 6) SET @Sql = @Sql+ ' MT.COLOR,  '
		IF (@SORTBY = 7) SET  @Sql = @Sql+ ' MT.PROVENANCE,  '
		IF (@SORTBY = 8) SET @Sql = @Sql+ ' MT.DIM,  '
		IF (@SORTBY = 9) SET @Sql = @Sql+ ' MT.COMPANY, '
		IF (@SORTBY = 10)SET  @Sql = @Sql+ ' MT.BARCODE, '
		SET @Sql = @Sql+ ' R.STARTDATE'
			 
		
		EXEC (@SQL)
	END
	
	SELECT * FROM #SECVIOL; 
	
/*
prcConnections_add2 '„œÌ—'
[RepTotalMatMoveMonthly] '1/1/2014 0:0:0.0', '12/10/2014 23:59:0.979', N'1-1-2014 0:0,1-31-2014 23:59,2-1-2014 0:0,2-28-2014 23:59,3-1-2014 0:0,3-31-2014 23:59,4-1-2014 0:0,4-30-2014 23:59,5-1-2014 0:0,5-31-2014 23:59,6-1-2014 0:0,6-30-2014 23:59,7-1-2014 0:0,7-31-2014 23:59,8-1-2014 0:0,8-31-2014 23:59,9-1-2014 0:0,9-30-2014 23:59,10-1-2014 0:0,10-31-2014 23:59,11-1-2014 0:0,11-30-2014 23:59,12-1-2014 0:0,12-10-2014 23:59', '00000000-0000-0000-0000-000000000000', '589d4bf3-3d41-413d-a5ed-71d0a7bf1c98', '00000000-0000-0000-0000-000000000000', '00000000-0000-0000-0000-000000000000', 'fed6b4a4-c167-4a80-a387-de22e2a53581', '', 3, '00000000-0000-0000-0000-000000000000', 0, 0, 0, 0, 0, 0
*/
#################################################################
#END   