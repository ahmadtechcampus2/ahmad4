CREATE FUNCTION FnStoresMaterialsExpireDates 
(      
      @DetailStores bit = 1  
) 
RETURNS TABLE  
AS 
RETURN  
( 
SELECT [mt].[Number] as [mtNumber] 
      ,[mt].[Name] [mtName] 
      ,[mt].[Code] [mtCode] 
      ,[mt].[LatinName] [mtLatinName] 
      ,[mt].[BarCode] [mtBarCode] 
      ,[mt].[CodedCode] [mtCodedCode] 
      ,[mt].[Vendor] MtVendor
      ,[mt].[Unity] [mtUnity] 
      ,[mt].[Spec]  [mtSpec] 
      ,[mt].[Qty] [mtQty] 
      ,[mt].[High] [mtHigh] 
      ,[mt].[Low] [mtLow] 
      ,[mt].[Whole] [mtWhole] 
      ,[mt].[Whole2] [mtWhole2] 
      ,[mt].[Half] [mtHalf] 
      ,[mt].[Half2] [mtHalf2] 
      ,[mt].[Retail2]  [mtRetail2]  
      ,[mt].[Retail]  [mtRetail]  
      ,[mt].[ENDUser2] [mtENDUser2] 
      ,[mt].[ENDUser] [mtENDUser] 
      ,[mt].[Export2] [mtExport2] 
      ,[mt].[Export] [mtExport] 
      ,[mt].[VENDor2] [mtVENDor2] 
      ,[mt].[MaxPrice2] [mtMaxPrice2] 
      ,[mt].[MaxPrice]  [mtMaxPrice] 
      ,[mt].[LastPrice3] [mtLastPrice3] 
      ,[mt].[LastPrice2] [mtLastPrice2] 
      ,[mt].[LastPrice] [mtLastPrice] 
      ,[mt].[Whole3] [mtWhole3] 
      ,[mt].[Half3] [mtHalf3] 
      ,[mt].[Retail3]  [mtRetail3]     
      ,[mt].[ENDUser3] [mtENDUser3] 
      ,[mt].[Export3] [mtExport3] 
      ,[mt].[VENDor3] [mtVENDor3] 
      ,[mt].[MaxPrice3] [mtMaxPrice3] 
      ,[mt].[AvgPrice] 
      ,[mt].[PriceType] [mtPriceType] 
      ,[mt].[SellType] [mtSellType] 
      ,[mt].[BonusOne] [mtBonusOne] 
      ,[mt].[CurrencyVal] [mtCurrencyVal] 
      ,[mt].[UseFlag] [mtUseFlag] 
      ,[mt].[Origin] [mtOrigin] 
      ,[mt].[Company] [mtCompany] 
      ,[mt].[Type] [mtType] 
      ,[mt].[Security] [mtSecurity] 
      ,[mt].[LastPriceDate] [mtLastPriceDate] 
      ,[mt].[Bonus] [mtBonus] 
      ,[mt].[Unit2Fact] [mtUnit2Fact] 
      ,[mt].[Unit2] [mtUnit2] 
      ,[mt].[Flag]   [mtFlag] 
      ,[mt].Unit3  [mtUnit3]   
      ,[mt].[Unit3Fact] [mtUnit3Fact] 
      ,(CASE [DefUnit]   
                  WHEN 2 THEN [Unit2Fact]   
                  WHEN 3 THEN [Unit3Fact]   
                  ELSE 1   
            END) AS [mtDefUnitFact] 
             
        ,(CASE [DefUnit]   
                  WHEN 2 THEN [Unit2]   
                  WHEN 3 THEN [Unit3]   
                  ELSE [Unity]   
            END) AS [mtDefUnitName] 
        ,[mt].Unit3FactFlag [mtUnit3FactFlag] 
        ,[mt].BarCode3 [mtBarCode3] 
      ,[mt].[Pos] [mtPos] 
      ,[mt].[Dim] [mtDim] 
      ,[mt].[ExpireFlag] [mtExpireFlag] 
      ,[mt].[ProductionFlag] [mtProductionFlag] 
      ,[mt].[Unit2FactFlag]  [mtUnit2FactFlag] 
      ,[mt].[BarCode2] [mtBarCode2] 
      ,[mt].[SNFlag] [mtSNFlag] 
      ,[mt].[ForceInSN] [mtForceInSN] 
      ,[mt].[ForceOutSN] [mtForceOutSN] 
      ,[mt].[VAT] [mtVat] 
      ,[mt].[Color] [mtColor] 
      ,[mt].[Provenance] [mtProvenance] 
      ,[mt].[Quality] [mtQuality] 
      ,[mt].[Model] [mtModel] 
      ,[mt].[Whole2] 
      ,[mt].[Half2] 
      ,[mt].[Retail2] 
      ,[mt].[ENDUser2] 
      ,[mt].[Export2] 
      ,[mt].[VENDor2] 
      ,[mt].[MaxPrice2] 
      ,[mt].[GUID] [mtGUID] 
      ,[mt].[GroupGUID] [mtGroup] 
      ,[mt].[PictureGUID] [mtPicture] 
      ,[mt].[CurrencyGUID] [mtCurrencyPtr] 
      ,[mt].[DefUnit] [mtDefUnit] 
      ,[mt].[bHide] 
      ,[mt].[branchMask] 
      ,[mt].[OldGUID] 
      ,[mt].[NewGUID] 
      ,[mt].[Assemble] 
      ,[mt].[OrderLimit] 
      ,[mt].[CalPriceFromDetail] 
      ,[mt].[ForceInExpire]   
      ,[mt].[ForceOutExpire] 
      ,[mt].[CreateDate] 
      ,[mt].[IsIntegerQuantity] 
        ,CASE @DetailStores WHEN 1 THEN [bi].[bistoreptr]  END StorePtr 
        ,CASE @DetailStores WHEN 1 THEN st.name  END StName 
        ,CASE @DetailStores WHEN 1 THEN st.latinname  END stLatinName 
        ,[mt].[GroupGuid] grGUID   
        ,[gr].[Name] as GrName 
        ,[gr].[Code] as GrCode 
        ,isNull(sum( biqty*btdirection), 0)  msQty 
        ,biexpiredate 
        ,isNull(bi.mtAvgPrice,0) mtAvgPrice
        
FROM 
        vwextENDed_bi bi 
right JOIN MT000 mt ON MT.guid = bi.bimatptr -- just to get the empty materials. 
right join gr000 gr on gr.guid = mt.groupGuid 
left join st000 st on st.guid = case @DetailStores WHEN 1 THEN bi.biStorePtr ELSE Null END 
GROUP BY 
       [mt].[Number]   
      ,[bi].[mtAvgPrice]
      ,[mt].[LastPrice2]
      ,[mt].[Name] 
      ,[mt].[Code]  
      ,[mt].[LatinName]  
      ,[mt].[BarCode]  
      ,[mt].[CodedCode]  
      ,[mt].[Unity]  
      ,[mt].[Vendor]
      ,[mt].[Spec]   
      ,[mt].[Qty]  
      ,[mt].[High]  
      ,[mt].[Low]  
      ,[mt].[Whole]  
      ,[mt].[Whole2]  
      ,[mt].[Half]  
      ,[mt].[Half2]  
      ,[mt].[Retail2]  
      ,[mt].[Retail]     
      ,[mt].[ENDUser]  
      ,[mt].[ENDUser3]  
      ,[mt].[Export2]  
      ,[mt].[VENDor2]  
      ,[mt].[MaxPrice2]  
      ,[mt].[AvgPrice] 
      ,[mt].[LastPrice3]  
      ,[mt].[Whole]  
      ,[mt].[Whole3]  
      ,[mt].[Half]  
      ,[mt].[Half3]  
      ,[mt].[Retail3]       
      ,[mt].[ENDUser2]  
      ,[mt].[Export3]  
      ,[mt].[Export]  
      ,[mt].[VENDor3]  
      ,[mt].[MaxPrice3]  
      ,[mt].[AvgPrice] 
      ,[mt].[LastPrice3] 
      ,[mt].[LastPrice]
      ,[mt].[PriceType] 
      ,[mt].[SellType] 
      ,[mt].[BonusOne] 
      ,[mt].[CurrencyVal]  
      ,[mt].[UseFlag] 
      ,[mt].[Origin] 
      ,[mt].[Company] 
      ,[mt].[Type] 
      ,[mt].[Security] 
      ,[mt].[LastPriceDate] 
      ,[mt].[Bonus] 
      ,[mt].[Unit2] 
      ,[mt].[Unit2Fact] 
      ,[mt].[Unit2] 
      ,[mt].[Unit2Fact] 
      ,[mt].[Flag]  
      ,[mt].[Pos] 
      ,[mt].[Dim] 
      ,[mt].[ExpireFlag] 
      ,[mt].[ProductionFlag] 
      ,[mt].[Unit2FactFlag] 
      ,[mt].[Unit2FactFlag] 
      ,[mt].[BarCode2] 
      ,[mt].[BarCode2] 
      ,[mt].[SNFlag]  
      ,[mt].[ForceInSN]   
      ,[mt].[ForceOutSN]  
      ,[mt].[VAT]  
      ,[mt].[Color]  
      ,[mt].[Provenance]  
      ,[mt].[Quality]  
      ,[mt].[Model]  
      ,[mt].[Whole2] 
      ,[mt].[Half2] 
      ,[mt].[Retail2] 
      ,[mt].[ENDUser2] 
      ,[mt].[Export2] 
      ,[mt].[VENDor2] 
      ,[mt].[MaxPrice2] 
      ,[mt].[Whole2] 
      ,[mt].[Half2] 
      ,[mt].[Retail2] 
      ,[mt].[ENDUser2] 
      ,[mt].[Export2] 
      ,[mt].[VENDor2] 
      ,[mt].[MaxPrice2] 
      ,[mt].[GUID]  
      ,[mt].[GroupGUID]   
      ,[mt].[PictureGUID] 
      ,[mt].[CurrencyGUID] 
      ,[mt].[DefUnit] 
      ,[mt].[bHide] 
      ,[mt].[branchMask] 
      ,[mt].[OldGUID] 
      ,[mt].[NewGUID] 
      ,[mt].[Assemble] 
      ,[mt].[OrderLimit] 
      ,[mt].[CalPriceFromDetail] 
      ,[mt].[ForceInExpire]  
      ,[mt].[ForceOutExpire] 
      ,[mt].[CreateDate] 
      ,[mt].[IsIntegerQuantity] 
      ,[mt].[Unit3] 
      ,[mt].[Unit3Fact] 
      ,[mt].[Unit3FactFlag] 
      ,[mt].BarCode3 
      ,[gr].Name 
      ,[gr].Code 
      ,CASE @DetailStores WHEN 1 THEN [bi].[bistoreptr]  END 
      ,CASE @DetailStores WHEN 1 THEN st.name  END  
      ,CASE @DetailStores WHEN 1 THEN st.latinname  END  
      ,biexpiredate 
      ,[mt].[MaxPrice] 
)
