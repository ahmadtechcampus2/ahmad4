CREATE VIEW vwStoresMaterialsExpireDates
AS 
SELECT [mt].[Number] AS [mtNumber]
      ,[mt].[Name] [mtName]
      ,[mt].[Code] [mtCode]
      ,[mt].[LatinName] [mtLatinName]
      ,[mt].[BarCode] [mtBarCode]
      ,[mt].[CodedCode] [mtCodedCode]
      ,[mt].[Unity] [mtUnity]
      ,[mt].[Spec]  [mtSpec]
      ,[mt].[Qty] [mtQty]
      ,[mt].[High] [mtHigh]
      ,[mt].[Low] [mtLow]
      ,[mt].[Whole] [mtWhole]
      ,[mt].[Whole2] [mtWhole2]
      ,[mt].[Half] [mtHalf]
      ,[mt].[Half2] [mtHalf2]
      ,[mt].[Retail2]  [mtRetail2]    
      ,[mt].[EndUser] [mtEndUser2]
      ,[mt].[Export2] [mtExport2]
      ,[mt].[Vendor2] [mtVendor2]
      ,[mt].[MaxPrice2] [mtMaxPrice2]
      ,[mt].[LastPrice3] [mtLastPrice3]
      ,[mt].[Whole3] [mtWhole3]
      ,[mt].[Half3] [mtHalf3]
      ,[mt].[Retail3]  [mtRetail3]    
      ,[mt].[EndUser] [mtEndUser3]
      ,[mt].[Export3] [mtExport3]
      ,[mt].[Vendor3] [mtVendor3]
      ,[mt].[MaxPrice3] [mtMaxPrice3]
      ,[mt].[AvgPrice]
      ,[mt].[PriceType] [mtPriceType]
      ,[mt].[SellType] [mtSellType]
      ,[mt].[BonusOne] [mtBonusOne]
      ,[mt].[CurrencyVal] [mtCurrencyVal]
      ,[mt].[UseFlag] [mtUseFlag]
      ,[mt].[Origin] [mtOrigin]
      ,[mt].[Company] [mtCompany]
      ,[mt].[Type] [mtType]
      ,[mt].[Security] [mtSecurity]
      ,[mt].[LastPriceDate] [mtLastPriceDate]
      ,[mt].[Bonus] [mtBonus]
      ,[mt].[Unit2Fact] [mtUnit2Fact]
      ,[mt].[Unit2] [mtUnit2]
      ,[mt].[Flag]   [mtFlag]
      ,[mt].Unit3  [mtUnit3]  
      ,[mt].[Unit3Fact] [mtUnit3Fact]
      ,(CASE [DefUnit]  
			WHEN 2 THEN [Unit2Fact]  
			WHEN 3 THEN [Unit3Fact]  
			ELSE 1  
		END) AS [mtDefUnitFact]
		
	  ,(CASE [DefUnit]  
			WHEN 2 THEN [Unit2]  
			WHEN 3 THEN [Unit3]  
			ELSE [Unity]  
		END) AS [mtDefUnitName]
	  ,[mt].Unit3FactFlag [mtUnit3FactFlag]
	  ,[mt].BarCode3 [mtBarCode3]
      ,[mt].[Pos] [mtPos]
      ,[mt].[Dim] [mtDim]
      ,[mt].[ExpireFlag] [mtExpireFlag]
      ,[mt].[ProductionFlag] [mtProductionFlag]
      ,[mt].[Unit2FactFlag]  [mtUnit2FactFlag]
      ,[mt].[BarCode2] [mtBarCode2]
      ,[mt].[SNFlag] [mtSNFlag]
      ,[mt].[ForceInSN] [mtForceInSN]
      ,[mt].[ForceOutSN] [mtForceOutSN]
      ,[mt].[VAT] [mtVat]
      ,[mt].[Color] [mtColor]
      ,[mt].[Provenance] [mtProvenance]
      ,[mt].[Quality] [mtQuality]
      ,[mt].[Model] [mtModel]
      ,[mt].[Whole2]
      ,[mt].[Half2]
      ,[mt].[Retail2]
      ,[mt].[EndUser2]
      ,[mt].[Export2]
      ,[mt].[Vendor2]
      ,[mt].[MaxPrice2]
      ,[mt].[LastPrice2]
      ,[mt].[GUID] [mtGUID]
      ,[mt].[GroupGUID] [mtGroup]
      ,[mt].[PictureGUID] [mtPicture]
      ,[mt].[CurrencyGUID] [mtCurrencyPtr]
      ,[mt].[DefUnit] [mtDefUnit]
      ,[mt].[bHide]
      ,[mt].[branchMask]
      ,[mt].[OldGUID]
      ,[mt].[NewGUID]
      ,[mt].[Assemble]
      ,[mt].[OrderLimit]
      ,[mt].[CalPriceFromDetail]
      ,[mt].[ForceInExpire]  
      ,[mt].[ForceOutExpire]
      ,[mt].[CreateDate]
      ,[mt].[IsIntegerQuantity]
	  ,[bi].[bistoreptr] [StorePtr]
	  ,[mt].[GroupGuid] [grGUID]  
	  ,[gr].[Name] as GrName
	  ,[gr].[Code] as GrCode
	  ,st.name StName
	  ,st.latinname [stLatinName]
	  ,isNull(sum( biqty*btdirection), 0)  [msQty]
	  ,biexpiredate
FROM
	  vwextended_bi bi
RIGHT JOIN MT000 mt ON MT.guid = bi.bimatptr -- just to get the empty materials.
RIGHT JOIN gr000 gr ON gr.guid = mt.groupGuid
LEFT JOIN st000 st ON st.guid = bi.biStorePtr
GROUP BY
       [mt].[Number]  
      ,[mt].[Name]
      ,[mt].[Code] 
      ,[mt].[LatinName] 
      ,[mt].[BarCode] 
      ,[mt].[CodedCode] 
      ,[mt].[Unity] 
      ,[mt].[Spec]  
      ,[mt].[Qty] 
      ,[mt].[High] 
      ,[mt].[Low] 
      ,[mt].[Whole] 
      ,[mt].[Whole2] 
      ,[mt].[Half] 
      ,[mt].[Half2] 
      ,[mt].[Retail2]      
      ,[mt].[EndUser] 
      ,[mt].[Export2] 
      ,[mt].[Vendor2] 
      ,[mt].[MaxPrice2] 
      ,[mt].[AvgPrice]
      ,[mt].[LastPrice3] 
      ,[mt].[Whole] 
      ,[mt].[Whole3] 
      ,[mt].[Half] 
      ,[mt].[Half3] 
      ,[mt].[Retail3]      
      ,[mt].[EndUser] 
      ,[mt].[Export3] 
      ,[mt].[Vendor3] 
      ,[mt].[MaxPrice3] 
      ,[mt].[AvgPrice]
      ,[mt].[LastPrice3] 
      ,[mt].[PriceType]
      ,[mt].[SellType]
      ,[mt].[BonusOne]
      ,[mt].[CurrencyVal] 
      ,[mt].[UseFlag]
      ,[mt].[Origin]
      ,[mt].[Company]
      ,[mt].[Type]
      ,[mt].[Security]
      ,[mt].[LastPriceDate]
      ,[mt].[Bonus]
      ,[mt].[Unit2]
      ,[mt].[Unit2Fact]
      ,[mt].[Unit2]
      ,[mt].[Unit2Fact]
      ,[mt].[Flag] 
      ,[mt].[Pos]
      ,[mt].[Dim]
      ,[mt].[ExpireFlag]
      ,[mt].[ProductionFlag]
      ,[mt].[Unit2FactFlag]
      ,[mt].[Unit2FactFlag]
      ,[mt].[BarCode2]
      ,[mt].[BarCode2]
      ,[mt].[SNFlag] 
      ,[mt].[ForceInSN]  
      ,[mt].[ForceOutSN] 
      ,[mt].[VAT] 
      ,[mt].[Color] 
      ,[mt].[Provenance] 
      ,[mt].[Quality] 
      ,[mt].[Model] 
      ,[mt].[Whole2]
      ,[mt].[Half2]
      ,[mt].[Retail2]
      ,[mt].[EndUser2]
      ,[mt].[Export2]
      ,[mt].[Vendor2]
      ,[mt].[MaxPrice2]
      ,[mt].[LastPrice2]
      ,[mt].[Whole2]
      ,[mt].[Half2]
      ,[mt].[Retail2]
      ,[mt].[EndUser2]
      ,[mt].[Export2]
      ,[mt].[Vendor2]
      ,[mt].[MaxPrice2]
      ,[mt].[LastPrice2]
      ,[mt].[GUID] 
      ,[mt].[GroupGUID]  
      ,[mt].[PictureGUID]
      ,[mt].[CurrencyGUID]
      ,[mt].[DefUnit]
      ,[mt].[bHide]
      ,[mt].[branchMask]
      ,[mt].[OldGUID]
      ,[mt].[NewGUID]
      ,[mt].[Assemble]
      ,[mt].[OrderLimit]
      ,[mt].[CalPriceFromDetail]
      ,[mt].[ForceInExpire] 
      ,[mt].[ForceOutExpire]
      ,[mt].[CreateDate]
      ,[mt].[IsIntegerQuantity]
	  ,[bi].[bistoreptr]
	  ,[mt].[Unit3]
	  ,[mt].[Unit3Fact]
	  ,[mt].[Unit3FactFlag]
	  ,[mt].BarCode3
	  ,[gr].Name
	  ,[gr].Code
	  ,[st].Name
	  ,[st].LatinName
	  ,biexpiredate
